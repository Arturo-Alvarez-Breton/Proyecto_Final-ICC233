<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Administración de Chats</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    .chat-list {
      max-height: 70vh;
      overflow-y: auto;
    }
    .user-card:hover {
      background-color: #f8f9fa;
      cursor: pointer;
    }
    /* Estilos para la ventana de chat */
    .chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    .chat-header {
      padding: 15px;
      background: #007bff;
      color: white;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 15px;
    }
    .chat-input {
      padding: 15px;
      border-top: 1px solid #ddd;
    }
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="/index">Blog</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="/index">Home</a></li>
        <li class="nav-item">
          <a class="nav-link" href="/mis-articulos"
             th:if="${usuario != null and (usuario.autor or usuario.admin)}">
            Mis Artículos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/usuarios"
             th:if="${usuario != null and usuario.admin}">Usuarios</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/chats"
             th:if="${usuario != null and usuario.admin}">
            Chats
          </a>
        </li>
      </ul>

      <!-- Menú de usuario -->
      <div class="dropdown" th:if="${usuario != null}">
        <a class="btn btn-link text-decoration-none dropdown-toggle d-flex align-items-center"
           href="#" role="button" id="dropdownMenuLink"
           data-bs-toggle="dropdown" aria-expanded="false">
          <img th:if="${usuario.fotoBase64}"
               th:src="@{'data:' + ${usuario.fotoMimeType} + ';base64,' + ${usuario.fotoBase64}}"
               class="user-avatar">
          <img th:unless="${usuario.fotoBase64}"
               src="/img/avatar-default.png"
               class="user-avatar">
          <span class="text-dark" th:text="${usuario.nombre}"></span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuLink">
          <li>
            <a class="dropdown-item" th:href="@{/perfil}">
              <i class="bi bi-person-circle me-2"></i>Mi Perfil
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item text-danger" href="/logout">
              <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h2 class="mb-4">Administración de Chats</h2>
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Chats Activos</h5>
    </div>
    <div class="card-body chat-list">
      <div class="list-group" id="chatList">
        <!-- La lista de chats se generará dinámicamente -->
      </div>
    </div>
  </div>
</div>

<!-- Ventana de Chat -->
<div class="chat-container" id="chatContainer">
  <div class="chat-header">
    <h5>Chat con: <span id="currentChatUser">@usuario</span></h5>
    <button class="btn btn-sm btn-close" onclick="toggleChat()"></button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="alert alert-info">Chat iniciado como administrador</div>
  </div>
  <div class="chat-input">
    <div class="input-group">
      <input type="text" id="messageInput" class="form-control" placeholder="Escribe tu mensaje...">
      <button class="btn btn-primary" onclick="sendMessage()">
        <i class="bi bi-send"></i>
      </button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Carga dinámica de la lista de chats
  function loadChatList() {
    fetch('/api/chats')
            .then(response => response.json())
            .then(chats => {
              const chatList = document.getElementById('chatList');
              chatList.innerHTML = ''; // Limpia la lista existente
              chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'list-group-item user-card';
                chatItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${chat.nombre}</h6>
                <small class="text-muted">@${chat.alias}</small>
              </div>
              <button class="btn btn-sm btn-primary" onclick="openAdminChat('${chat.alias}')">
                <i class="bi bi-chat"></i> Iniciar Chat
              </button>
            </div>
          `;
                chatList.appendChild(chatItem);
              });
            })
            .catch(error => console.error('Error al cargar los chats:', error));
  }

  // Abre el chat de un usuario y carga su historial
  function openAdminChat(username) {
    document.getElementById('currentChatUser').textContent = '@' + username;
    toggleChat(true);
    fetch(`/api/chats/${username}`)
            .then(response => response.json())
            .then(messages => renderMessages(messages))
            .catch(error => console.error('Error al cargar el historial:', error));
  }

  function renderMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = ''; // Limpia mensajes anteriores

    const userSpan = document.getElementById('currentChatUser');
    // Tomamos el texto y removemos el '@' al inicio, si existe
    let chatUser = userSpan ? userSpan.textContent.trim() : 'Desconocido';
    if (chatUser.startsWith('@')) {
      chatUser = chatUser.substring(1);
    }

    messages.forEach(message => {
      const messageElement = document.createElement('div');
      messageElement.className = 'alert alert-light';
      messageElement.innerHTML = `<strong>${chatUser}:</strong> ${message.contenido}`;
      chatMessages.appendChild(messageElement);
    });
  }



  // Muestra u oculta la ventana de chat
  function toggleChat(open = false) {
    const chatContainer = document.getElementById('chatContainer');
    if (open || chatContainer.style.display === 'none' || chatContainer.style.display === '') {
      chatContainer.style.display = 'flex';
    } else {
      chatContainer.style.display = 'none';
    }
  }

  function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const contenido = messageInput.value.trim();

    if (contenido) {
      // Extrae el receptor desde el span que muestra el alias del chat, removiendo el '@'
      let receptor = document.getElementById('currentChatUser').textContent.trim();
      if (receptor.startsWith('@')) {
        receptor = receptor.substring(1);
      }

      // Crea el objeto mensaje que se enviará al backend
      const mensaje = {
        contenido: contenido,
        receptor: receptor
      };

      // Realiza la petición POST al endpoint del admin para guardar el mensaje en la BD
      fetch('/api/chats/admin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(mensaje)
      })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else {
                  throw new Error('Error al guardar el mensaje en la base de datos');
                }
              })
              .then(data => {
                // Al guardar correctamente, actualiza la interfaz del chat
                const userName = document.querySelector('.dropdown .text-dark')?.textContent.trim() || '[Usuario]';
                const messageElement = document.createElement('div');
                messageElement.className = 'alert alert-light';
                messageElement.innerHTML = `<strong>${userName}:</strong> ${contenido}`;
                document.getElementById('chatMessages').appendChild(messageElement);
                // Auto-scroll al último mensaje
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                messageInput.value = '';
              })
              .catch(error => console.error('Error en la petición:', error));
    }
  }


  // Cargar la lista de chats al cargar la página
  document.addEventListener('DOMContentLoaded', loadChatList);
</script>
</body>
</html>
